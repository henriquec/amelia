#!/usr/bin/env ruby
require 'pathname'
require 'fileutils'
require 'optparse'

# path to your application root.
APP_ROOT = Pathname.new File.expand_path('../../', __FILE__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

# Parses command line options
without_groups_bundler_argument = ''
use_npm = false
OptionParser.new do |opts|
  opts.on('-x GROUPS', "--without-gem-groups=GROUPS", "Removes some gem groups from install") do |groups|
    without_groups_bundler_argument = "--without #{groups}"
  end

  opts.on("--use-npm", "Uses NPM instead of Yarn") do |groups|
    use_npm = true
  end
end.parse!

FileUtils.chdir APP_ROOT do
  puts '== Installing Gem dependencies =='
  system! 'gem install bundler --conservative'
  system('bin/bundle check') || system!("bin/bundle install #{without_groups_bundler_argument}")
  system('bin/bundle-detached check') || system!("bin/bundle-detached install #{without_groups_bundler_argument}")

  puts "\n== Installing NPM dependencies =="
  if use_npm
    system! 'npm install'
  else
    system! 'npm install yarn'
    system! 'bin/yarn install'
  end

  puts "\n== Preparing database =="
  system! 'bin/rails db:setup'

  puts "\n== Removing old logs and tempfiles =="
  system! 'bin/rails log:clear tmp:clear'
end
